import {
  PrivateKey,
  Transaction,
  Script,
  P2PKH,
  BigNumber,
  Signature,
  SatoshisPerKilobyte 
} from "@bsv/sdk";
import {
  DaiaOfferContentSchema,
  DaiaAgreementSchema,
  DaiaRequirementType,
  type DaiaOfferContent,
  type DaiaAgreement,
} from "../types/offer";
import { serializeOfferContent } from "../verification/serialization";
import { OpReturnTemplate } from "./templates";

// --- Configuration ---
const NETWORK = "test"; // 'main' or 'test'
const WOC_BASE_URL = `https://api.whatsonchain.com/v1/bsv/${NETWORK}`;
const TX_TO_GENERATE = 12


const PRIVATE_KEY_WIF = 'KzhctGwdZmeGqSVz7P6L3gjQbV7KWuiL3LcWzNkxPnt7iXb89j6f';

const PARENT_TX_HEX = "01000000019a50074ef357f4d98ff4a9ec27ffe21bee13ad5223bff5ad015fbfbb6a12751d010000006a473044022008c02fbe703e5eb6992e6202112bc070476373fc19dfef8ff7406b5ccdd6e89f022007d653a9d1981e531fac0b34c20cb22c826375f3eca6b843a9a2a98502986f2e412102ab81b125352e37d94888d1b30d68fecbcbcae03346124b7fa88c7fc40df37ff4ffffffff0b0100000000000000fd2e02006a4d29027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c224920616772656520746f2070617920666f722070616b696e672035207573645c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139383731313031305c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313938373131303130222c227369676e6174757265223a2233303435303232313030653035653662636139626464633264353139353230613562626533663036316137323764646638366137633638323730656232346265633162303539303834613032323030663837376436323763313931366235623239656532613631616638653738623263643061626561343735613861376139633864376665633439633164653630227d7d7d010000000000000037006a34496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c650100000000000000fd2902006a4d24027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c224920616772656520746f207a64616320696e7a796e6965726b655c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139383731313031395c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313938373131303139222c227369676e6174757265223a2233303435303232313030633830333433613533616261343062353663383062633763323361363366396162303062383430646438663730313665366665646332316538393262323361313032323036666135663766336536623034636537343431613332633761376431646663316464363637663862623139333866656666613838353533633637383631336164227d7d7d0100000000000000fd2c02006a4d27027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c2250727a796bc58261646f776120342044414941207a61776172746fc59bc4875c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139383731313032335c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313938373131303233222c227369676e6174757265223a223330343430323230306465386639616233336461363635646330323939643636303363613762626335306333353134646166386335626538663739366561653535656233363831623032323036636637343063376339616335613838643939396230646662356366613464386366386564646233346565623132326333316234663036343864633039303363227d7d7d0100000000000000fd2c02006a4d27027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c224920616772656520746f2070617920666f722070616b696e672035207573645c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139383731313032385c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313938373131303238222c227369676e6174757265223a223330343430323230306330653030346631316465623666656139313838616439613164613838393562316230373965316562313238333565373135303839333132353939343363323032323033326666393664653535363334613461333932613439313236343663316264626166643863613034333963306239663436366364613735343662656135343738227d7d7d010000000000000037006a34496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c6501000000000000001d006a1a4920616772656520746f207a64616320696e7a796e6965726b650100000000000000fd2e02006a4d29027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c2250727a796bc58261646f776120342044414941207a61776172746fc59bc4875c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139383731313033335c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313938373131303333222c227369676e6174757265223a2233303435303232313030646230656439363462333632323562616164386635636230663335613035313261383338626634653861643461313536666437326330336537306263323533633032323032643964393466383861353463656264393161613430393732666133356538326538323531383935303164656162383832666433333234383462343534383466227d7d7d010000000000000022006a1f4920616772656520746f2070617920666f722070616b696e67203520757364010000000000000037006a34496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c6530860100000000001976a914505328a64095d203b9de8cd3d341c6926435c86088ac00000000";
const VOUT_INDEX = 10;

const SATOSHI_FEE_PER_KB = 4;


// --- Helpers ---

async function broadcastTx(txHex: string): Promise<string> {
  const response = await fetch(`${WOC_BASE_URL}/tx/raw`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ txhex: txHex }),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Broadcast failed: ${errorText}`);
  }

  return response.json(); // Returns txid
}


const sampleLanguageOfferContents = [
    "I agree to pay for paking 5 usd",
    "Ich stimme zu, dass ich 5 USD für die Pankung zahle",
    "I agree to zdac inzynierke",
    "Przykładowa 4 DAIA zawartość"
]


const generateDaiaTransactionOutputPayload = (content: string, signeePrivateKey: PrivateKey, parentTxHex: string) => {
    const offerContent: DaiaOfferContent = {
    naturalLanguageOfferContent: content + Date.now().toString(),
    requirements: new Map([
      [
        "req_signature",
        {
          type: DaiaRequirementType.Sign,
          pubKey: signeePrivateKey.toPublicKey().toString(),
          offererNonce: "random_nonce_from_offerer_" + Date.now(),
        },
      ],
    ]),
    
  };

  const offerContentSerialized = serializeOfferContent(offerContent);
//   console.log("Serialized Offer:", offerContentSerialized);

  // 4. Create Proofs
  const signeeNonce = "random_nonce_from_signee_" + Date.now();
  
  const requirement = offerContent.requirements.get("req_signature");
  if (!requirement || requirement.type !== DaiaRequirementType.Sign) {
    throw new Error("Signature requirement not found or invalid type");
  }

  const messageToSign = `${offerContentSerialized}:${requirement.offererNonce}:${signeeNonce}`;
  
  const encoder = new TextEncoder();
  const signature = signeePrivateKey.sign(
    Array.from(encoder.encode(messageToSign))
  );

  // 5. Create Agreement
  const agreement: DaiaAgreement = {
    offerContentSerialized,
    proofs: new Map([
      [
        "req_signature",
        {
          type: DaiaRequirementType.Sign,
          signeeNonce,
          signature: signature.toDER("hex") as string,
        },
      ],
    ]),
  };

  // Validate Agreement Structure
  DaiaAgreementSchema.parse(agreement);
//   console.log("Agreement structure is valid.");

  // 6. Prepare Blockchain Transaction
  const agreementJson = JSON.stringify({
    ...agreement,
    proofs: Object.fromEntries(agreement.proofs),
  });

  const dataScript = new OpReturnTemplate().lock(agreementJson);

  return {
    satoshis: 1,
    lockingScript: dataScript
  }
}

const generateSimpleTransactionOutputPayload = (content: string) => {
    return {
        satoshis: 1,
        lockingScript: new OpReturnTemplate().lock(content + Date.now().toString())
    }
}

const generateDaiaOrSimpleTransactionOutputPayload = (content: string, signeePrivateKey: PrivateKey, parentTxHex: string) => {
    
    const isDaiaTransactionRandom = Math.random() > 0.5;
    
    if (isDaiaTransactionRandom) {
        return generateDaiaTransactionOutputPayload(content, signeePrivateKey, parentTxHex);   
    }

    return generateSimpleTransactionOutputPayload(content);
}


// --- Main Example ---

async function main() {
  console.log("--- DAIA Transaction Example ---");

  // 1. Setup Identity (Offerer and Signee)
  const signeePrivateKey = PrivateKey.fromWif(PRIVATE_KEY_WIF);
  const parentTxHex = PARENT_TX_HEX
  const signeeAddress = signeePrivateKey.toAddress();
  console.log(`Signee Address: ${signeeAddress.toString()}`);

  const newTx = new Transaction();
  newTx.addInput({
    sourceTransaction: Transaction.fromHex(parentTxHex),
    sourceOutputIndex: VOUT_INDEX,
    unlockingScriptTemplate: new P2PKH().unlock(signeePrivateKey),
  })

  for (let i = 0; i < TX_TO_GENERATE; i++) {
    const content = sampleLanguageOfferContents[i % sampleLanguageOfferContents.length];
    const { satoshis, lockingScript } = generateDaiaOrSimpleTransactionOutputPayload(content, signeePrivateKey, parentTxHex);

    newTx.addOutput({
      satoshis,
      lockingScript
    })
  }

  newTx.addOutput({
    change: true,
    lockingScript: new P2PKH().lock(signeePrivateKey.toAddress())
  })

  await newTx.fee(new SatoshisPerKilobyte(SATOSHI_FEE_PER_KB))

  await newTx.sign();

  console.log("Broadcasting transaction...");
  const txId = await broadcastTx(newTx.toHex());

  console.log(newTx.getFee());
  console.log('txId', txId);

}

main().catch(console.error);
