import {
  PrivateKey,
  Transaction,
  Script,
  P2PKH,
  BigNumber,
  Signature,
  SatoshisPerKilobyte 
} from "@bsv/sdk";
import {
  DaiaOfferContentSchema,
  DaiaAgreementSchema,
  DaiaRequirementType,
  type DaiaOfferContent,
  type DaiaAgreement,
} from "../types/offer";
import { serializeOfferContent } from "../verification/serialization";
import { OpReturnTemplate } from "./templates";

// --- Configuration ---
const NETWORK = "test"; // 'main' or 'test'
const WOC_BASE_URL = `https://api.whatsonchain.com/v1/bsv/${NETWORK}`;
const TX_TO_GENERATE = 12


const PRIVATE_KEY_WIF = 'KzhctGwdZmeGqSVz7P6L3gjQbV7KWuiL3LcWzNkxPnt7iXb89j6f';

const PARENT_TX_HEX = "010000000130aa3bcdb253bd18659506b85fa5200c042e203e902d37d7349fce9c356648ca0c0000006a473044022078422f331369b3a4134f6d2c5d386b9978b82454463ee409f444171c53fc3e2c022016f65f488c44be2c1682a416211903d6e9e6685c30d28a0d872aea08f93de7f4412102ab81b125352e37d94888d1b30d68fecbcbcae03346124b7fa88c7fc40df37ff4ffffffff0d01000000000000002f006a2c4920616772656520746f2070617920666f722070616b696e67203520757364313736343230333332383336390100000000000000fd4e02006a4d49027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c22496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c65313736343230333332383337305c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343230333332383337315c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634323033333238333731222c227369676e6174757265223a223330343430323230346430656339623536636261313166323430326233363130663833363866373837653935353931316562316265393435383336366362306231316537363039353032323034393564376634626339363764363531666433623531623434653463373230316631323665636531386236383764393139323233333165653462346363643166227d7d7d0100000000000000fd3602006a4d31027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c224920616772656520746f207a64616320696e7a796e6965726b65313736343230333332383337375c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343230333332383337395c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634323033333238333739222c227369676e6174757265223a2233303435303232313030666565363732353762653431323935323565326664393639326537393162653564346439613533376265303534643863366635386533353162356662356630363032323035373361373633666431663038303564373963313736363139316532303539366130353437303130333161346131313966663238646432346136616561326563227d7d7d01000000000000002f006a2c50727a796bc58261646f776120342044414941207a61776172746fc59bc4873137363432303333323833383401000000000000002f006a2c4920616772656520746f2070617920666f722070616b696e67203520757364313736343230333332383338340100000000000000fd4e02006a4d49027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c22496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c65313736343230333332383338345c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343230333332383338365c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634323033333238333836222c227369676e6174757265223a223330343430323230333331336631636534383432646630396530636635333239383938316362333538353335656237373639616637313064336239373034306563366666666637643032323037326634363866396364366132623466386537306634616534643637656234643135306462613862353337383830633836616665366435393035356562346462227d7d7d01000000000000002a006a274920616772656520746f207a64616320696e7a796e6965726b65313736343230333332383338380100000000000000fd3b02006a4d36027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c2250727a796bc58261646f776120342044414941207a61776172746fc59bc487313736343230333332383338385c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343230333332383339305c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634323033333238333930222c227369676e6174757265223a2233303435303232313030613063616434353562373135646364353738623861313033636262383335396263316536323463336438636563633166313238633432373037636561616430623032323035306439313037366364666530383731396430663433316134323339303737393433373662653065623836653237343938346263643863616231646266303265227d7d7d01000000000000002f006a2c4920616772656520746f2070617920666f722070616b696e67203520757364313736343230333332383339320100000000000000fd5002006a4d4b027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c22496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c65313736343230333332383339335c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343230333332383339345c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634323033333238333934222c227369676e6174757265223a2233303435303232313030633462646364663734306232656431313736333934393864333461306330383566333532656236303237336438383733643766393837623539383638323565323032323035626138653766633435313830386233663435616335306433326232646238633531313132373239626666343466653561326565653166323330613365333238227d7d7d01000000000000002a006a274920616772656520746f207a64616320696e7a796e6965726b653137363432303333323833393701000000000000002f006a2c50727a796bc58261646f776120342044414941207a61776172746fc59bc48731373634323033333238333937fa850100000000001976a914505328a64095d203b9de8cd3d341c6926435c86088ac00000000";
const VOUT_INDEX = 12;

const SATOSHI_FEE_PER_KB = 4;

const SAMPLE_OFFER_LANGUAGE_CONTENTS = [
    "I agree to pay for paking 5 usd",
    "Ich stimme zu, dass ich 5 USD für die Pankung zahle",
    "I agree to zdac inzynierke",
    "Przykładowa 4 DAIA zawartość"
]

// --- Helpers ---

async function broadcastTx(txHex: string): Promise<string> {
  const response = await fetch(`${WOC_BASE_URL}/tx/raw`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ txhex: txHex }),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Broadcast failed: ${errorText}`);
  }

  return response.json(); // Returns txid
}


const generateDaiaTransactionOutputPayload = (content: string, signeePrivateKey: PrivateKey, parentTxHex: string) => {
    const offerContent: DaiaOfferContent = {
    naturalLanguageOfferContent: content + Date.now().toString(),
    requirements: new Map([
      [
        "req_signature",
        {
          type: DaiaRequirementType.Sign,
          pubKey: signeePrivateKey.toPublicKey().toString(),
          offererNonce: "random_nonce_from_offerer_" + Date.now(),
        },
      ],
    ]),
    
  };

  const offerContentSerialized = serializeOfferContent(offerContent);
//   console.log("Serialized Offer:", offerContentSerialized);

  // 4. Create Proofs
  const signeeNonce = "random_nonce_from_signee_" + Date.now();
  
  const requirement = offerContent.requirements.get("req_signature");
  if (!requirement || requirement.type !== DaiaRequirementType.Sign) {
    throw new Error("Signature requirement not found or invalid type");
  }

  const messageToSign = `${offerContentSerialized}:${requirement.offererNonce}:${signeeNonce}`;
  
  const encoder = new TextEncoder();
  const signature = signeePrivateKey.sign(
    Array.from(encoder.encode(messageToSign))
  );

  // 5. Create Agreement
  const agreement: DaiaAgreement = {
    offerContentSerialized,
    proofs: new Map([
      [
        "req_signature",
        {
          type: DaiaRequirementType.Sign,
          signeeNonce,
          signature: signature.toDER("hex") as string,
        },
      ],
    ]),
  };

  // Validate Agreement Structure
  DaiaAgreementSchema.parse(agreement);
//   console.log("Agreement structure is valid.");

  // 6. Prepare Blockchain Transaction
  const agreementJson = JSON.stringify({
    ...agreement,
    proofs: Object.fromEntries(agreement.proofs),
  });

  const dataScript = new OpReturnTemplate().lock(agreementJson);

  return {
    satoshis: 1,
    lockingScript: dataScript
  }
}

const generateSimpleTransactionOutputPayload = (content: string) => {
    return {
        satoshis: 1,
        lockingScript: new OpReturnTemplate().lock(content + Date.now().toString())
    }
}

const generateDaiaOrSimpleTransactionOutputPayload = (content: string, signeePrivateKey: PrivateKey, parentTxHex: string) => {
    
    const isDaiaTransactionRandom = Math.random() > 0.5;
    
    if (isDaiaTransactionRandom) {
        return generateDaiaTransactionOutputPayload(content, signeePrivateKey, parentTxHex);   
    }

    return generateSimpleTransactionOutputPayload(content);
}


// --- Main Example ---

async function main() {
  console.log("--- DAIA Transaction Example ---");

  // 1. Setup Identity (Offerer and Signee)
  const signeePrivateKey = PrivateKey.fromWif(PRIVATE_KEY_WIF);
  const parentTxHex = PARENT_TX_HEX
  const signeeAddress = signeePrivateKey.toAddress();
  console.log(`Signee Address: ${signeeAddress.toString()}`);

  const newTx = new Transaction();
  newTx.addInput({
    sourceTransaction: Transaction.fromHex(parentTxHex),
    sourceOutputIndex: VOUT_INDEX,
    unlockingScriptTemplate: new P2PKH().unlock(signeePrivateKey),
  })

  for (let i = 0; i < TX_TO_GENERATE; i++) {
    const content = SAMPLE_OFFER_LANGUAGE_CONTENTS[i % SAMPLE_OFFER_LANGUAGE_CONTENTS.length];
    const { satoshis, lockingScript } = generateDaiaOrSimpleTransactionOutputPayload(content, signeePrivateKey, parentTxHex);

    newTx.addOutput({
      satoshis,
      lockingScript
    })
  }

  newTx.addOutput({
    change: true,
    lockingScript: new P2PKH().lock(signeePrivateKey.toAddress())
  })

  await newTx.fee(new SatoshisPerKilobyte(SATOSHI_FEE_PER_KB))

  await newTx.sign();

  console.log("Broadcasting transaction...");
  const txId = await broadcastTx(newTx.toHex());

  console.log(newTx.getFee());
  console.log('txId', txId);

}

main().catch(console.error);
