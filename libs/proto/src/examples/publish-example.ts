import {
  PrivateKey,
  Transaction,
  Script,
  P2PKH,
  BigNumber,
  Signature,
  SatoshisPerKilobyte 
} from "@bsv/sdk";
import {
  DaiaOfferContentSchema,
  DaiaAgreementSchema,
  DaiaRequirementType,
  type DaiaOfferContent,
  type DaiaAgreement,
} from "../types/offer";
import { serializeOfferContent } from "../verification/serialization";
import { OpReturnTemplate } from "./templates";

// --- Configuration ---
const NETWORK = "test"; // 'main' or 'test'
const WOC_BASE_URL = `https://api.whatsonchain.com/v1/bsv/${NETWORK}`;
const TX_TO_GENERATE = 12


const PRIVATE_KEY_WIF = 'KzhctGwdZmeGqSVz7P6L3gjQbV7KWuiL3LcWzNkxPnt7iXb89j6f';

const PARENT_TX_HEX = "0100000001868e391f1055b3bbce8d2ba4d75f78e3d45b7dcca2596e37e00bdc46e47b168b0a0000006a47304402203a42712534da34ba310f9c3f198af2429c57e4ea3223654e97f111eb00bb8af50220182009e0603a8e326553fa95546df423bfef427b7a0565c190c48b341d923ce0412102ab81b125352e37d94888d1b30d68fecbcbcae03346124b7fa88c7fc40df37ff4ffffffff0d0100000000000000fd3902006a4d34027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c224920616772656520746f2070617920666f722070616b696e67203520757364313736343139393936363637315c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139393936363637335c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313939393636363733222c227369676e6174757265223a223330343430323230313234616239633733303863636663303338393561353465303937383434643039373631393865366463363439663937316238633538636530363262613965333032323030653162663939636362633839393536636237373433373230663238316333386138376532343861663832663036323832333439393532303938323862623637227d7d7d010000000000000044006a41496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c653137363431393939363636373901000000000000002a006a274920616772656520746f207a64616320696e7a796e6965726b65313736343139393936363637390100000000000000fd3902006a4d34027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c2250727a796bc58261646f776120342044414941207a61776172746fc59bc487313736343139393936363637395c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139393936363638315c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313939393636363831222c227369676e6174757265223a223330343430323230353231663230386537363131393637363735653939333230306233613464653464653261663832383364303963306463363066303064383964396265393139633032323034626439656563383539363562363137336262626639626136333434633231326331626265323061653264386361666663356134386632616563666436346337227d7d7d01000000000000002f006a2c4920616772656520746f2070617920666f722070616b696e6720352075736431373634313939393636363835010000000000000044006a41496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c65313736343139393936363638350100000000000000fd3402006a4d2f027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c224920616772656520746f207a64616320696e7a796e6965726b65313736343139393936363638355c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139393936363638375c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313939393636363837222c227369676e6174757265223a223330343430323230366438306636343864346436663264343065623665323531623065393431313464656638656639373832323432326565356334373738373164366335623631383032323037306636313832343961626465316366316565323361656238666461316238626432373638613734663739666331643731646237313635626239346636623665227d7d7d01000000000000002f006a2c50727a796bc58261646f776120342044414941207a61776172746fc59bc4873137363431393939363636383901000000000000002f006a2c4920616772656520746f2070617920666f722070616b696e6720352075736431373634313939393636363839010000000000000044006a41496368207374696d6d65207a752c2064617373206963682035205553442066c3bc72206469652050616e6b756e67207a61686c65313736343139393936363638390100000000000000fd3602006a4d31027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c224920616772656520746f207a64616320696e7a796e6965726b65313736343139393936363638395c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139393936363639315c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313939393636363931222c227369676e6174757265223a2233303435303232313030623361363531373238613739616365663034666562383462653131386366373434373462383861633339373065346433626139386335323738336532333964373032323032303730303962363334376530346337646465633663316162633833366430633264343866316437396664306630636538363935353863373363353661393839227d7d7d0100000000000000fd3902006a4d34027b226f66666572436f6e74656e7453657269616c697a6564223a227b5c226e61747572616c4c616e67756167654f66666572436f6e74656e745c223a5c2250727a796bc58261646f776120342044414941207a61776172746fc59bc487313736343139393936363639335c222c5c22726571756972656d656e74735c223a7b5c227265715f7369676e61747572655c223a7b5c22747970655c223a5c227369676e5c222c5c227075624b65795c223a5c223032616238316231323533353265333764393438383864316233306436386665636263626361653033333436313234623766613838633766633430646633376666345c222c5c226f6666657265724e6f6e63655c223a5c2272616e646f6d5f6e6f6e63655f66726f6d5f6f6666657265725f313736343139393936363639355c227d7d7d222c2270726f6f6673223a7b227265715f7369676e6174757265223a7b2274797065223a227369676e222c227369676e65654e6f6e6365223a2272616e646f6d5f6e6f6e63655f66726f6d5f7369676e65655f31373634313939393636363935222c227369676e6174757265223a223330343430323230376461653334363231633030373935636562666265643739656636653062383366373337323464346435313136396161396364613630623865316365323430373032323032373762326564373263346362633133636534396230316537323431643566316238626536653733383238326532363731636633323431353934353538633563227d7d7d15860100000000001976a914505328a64095d203b9de8cd3d341c6926435c86088ac00000000";
const VOUT_INDEX = 12;

const SATOSHI_FEE_PER_KB = 4;

const SAMPLE_OFFER_LANGUAGE_CONTENTS = [
    "I agree to pay for paking 5 usd",
    "Ich stimme zu, dass ich 5 USD für die Pankung zahle",
    "I agree to zdac inzynierke",
    "Przykładowa 4 DAIA zawartość"
]

// --- Helpers ---

async function broadcastTx(txHex: string): Promise<string> {
  const response = await fetch(`${WOC_BASE_URL}/tx/raw`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ txhex: txHex }),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Broadcast failed: ${errorText}`);
  }

  return response.json(); // Returns txid
}


const generateDaiaTransactionOutputPayload = (content: string, signeePrivateKey: PrivateKey, parentTxHex: string) => {
    const offerContent: DaiaOfferContent = {
    naturalLanguageOfferContent: content + Date.now().toString(),
    requirements: new Map([
      [
        "req_signature",
        {
          type: DaiaRequirementType.Sign,
          pubKey: signeePrivateKey.toPublicKey().toString(),
          offererNonce: "random_nonce_from_offerer_" + Date.now(),
        },
      ],
    ]),
    
  };

  const offerContentSerialized = serializeOfferContent(offerContent);
//   console.log("Serialized Offer:", offerContentSerialized);

  // 4. Create Proofs
  const signeeNonce = "random_nonce_from_signee_" + Date.now();
  
  const requirement = offerContent.requirements.get("req_signature");
  if (!requirement || requirement.type !== DaiaRequirementType.Sign) {
    throw new Error("Signature requirement not found or invalid type");
  }

  const messageToSign = `${offerContentSerialized}:${requirement.offererNonce}:${signeeNonce}`;
  
  const encoder = new TextEncoder();
  const signature = signeePrivateKey.sign(
    Array.from(encoder.encode(messageToSign))
  );

  // 5. Create Agreement
  const agreement: DaiaAgreement = {
    offerContentSerialized,
    proofs: new Map([
      [
        "req_signature",
        {
          type: DaiaRequirementType.Sign,
          signeeNonce,
          signature: signature.toDER("hex") as string,
        },
      ],
    ]),
  };

  // Validate Agreement Structure
  DaiaAgreementSchema.parse(agreement);
//   console.log("Agreement structure is valid.");

  // 6. Prepare Blockchain Transaction
  const agreementJson = JSON.stringify({
    ...agreement,
    proofs: Object.fromEntries(agreement.proofs),
  });

  const dataScript = new OpReturnTemplate().lock(agreementJson);

  return {
    satoshis: 1,
    lockingScript: dataScript
  }
}

const generateSimpleTransactionOutputPayload = (content: string) => {
    return {
        satoshis: 1,
        lockingScript: new OpReturnTemplate().lock(content + Date.now().toString())
    }
}

const generateDaiaOrSimpleTransactionOutputPayload = (content: string, signeePrivateKey: PrivateKey, parentTxHex: string) => {
    
    const isDaiaTransactionRandom = Math.random() > 0.5;
    
    if (isDaiaTransactionRandom) {
        return generateDaiaTransactionOutputPayload(content, signeePrivateKey, parentTxHex);   
    }

    return generateSimpleTransactionOutputPayload(content);
}


// --- Main Example ---

async function main() {
  console.log("--- DAIA Transaction Example ---");

  // 1. Setup Identity (Offerer and Signee)
  const signeePrivateKey = PrivateKey.fromWif(PRIVATE_KEY_WIF);
  const parentTxHex = PARENT_TX_HEX
  const signeeAddress = signeePrivateKey.toAddress();
  console.log(`Signee Address: ${signeeAddress.toString()}`);

  const newTx = new Transaction();
  newTx.addInput({
    sourceTransaction: Transaction.fromHex(parentTxHex),
    sourceOutputIndex: VOUT_INDEX,
    unlockingScriptTemplate: new P2PKH().unlock(signeePrivateKey),
  })

  for (let i = 0; i < TX_TO_GENERATE; i++) {
    const content = SAMPLE_OFFER_LANGUAGE_CONTENTS[i % SAMPLE_OFFER_LANGUAGE_CONTENTS.length];
    const { satoshis, lockingScript } = generateDaiaOrSimpleTransactionOutputPayload(content, signeePrivateKey, parentTxHex);

    newTx.addOutput({
      satoshis,
      lockingScript
    })
  }

  newTx.addOutput({
    change: true,
    lockingScript: new P2PKH().lock(signeePrivateKey.toAddress())
  })

  await newTx.fee(new SatoshisPerKilobyte(SATOSHI_FEE_PER_KB))

  await newTx.sign();

  console.log("Broadcasting transaction...");
  const txId = await broadcastTx(newTx.toHex());

  console.log(newTx.getFee());
  console.log('txId', txId);

}

main().catch(console.error);
